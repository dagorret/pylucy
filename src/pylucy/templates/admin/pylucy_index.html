{% extends "admin/index.html" %}
{% load static %}

{% block content %}
{{ block.super }}

{# SecciÃ³n de Prueba de Email con Microsoft Graph API #}
<div class="module" style="margin-top: 20px; border-left: 4px solid #0078d4;">
    <h2>ğŸ“§ Probar EnvÃ­o de Email (Office 365 / Graph API)</h2>
    <p style="color: #666; margin-bottom: 15px;">
        EnvÃ­a un email de prueba usando Microsoft Graph API con las credenciales ya configuradas en Azure AD.
    </p>

    <form id="test-email-form" style="background-color: #f9f9f9; padding: 20px; border-radius: 4px;">
        {% csrf_token %}

        <div style="margin-bottom: 15px;">
            <label for="email_from" style="display: block; font-weight: bold; margin-bottom: 5px;">
                Remitente (From):
            </label>
            <input
                type="email"
                id="email_from"
                name="email_from"
                placeholder="admin@eco.unrc.edu.ar"
                required
                style="width: 100%; max-width: 500px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"
            />
            <small style="color: #666;">Debe ser un buzÃ³n vÃ¡lido en tu Office 365</small>
        </div>

        <div style="margin-bottom: 15px;">
            <label for="destinatario" style="display: block; font-weight: bold; margin-bottom: 5px;">
                Destinatario (Para):
            </label>
            <input
                type="email"
                id="destinatario"
                name="destinatario"
                placeholder="ejemplo@dominio.com"
                required
                style="width: 100%; max-width: 500px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"
            />
        </div>

        <div style="margin-bottom: 15px;">
            <label for="mensaje" style="display: block; font-weight: bold; margin-bottom: 5px;">
                Mensaje personalizado (opcional):
            </label>
            <textarea
                id="mensaje"
                name="mensaje"
                rows="4"
                placeholder="Escribe aquÃ­ tu mensaje de prueba..."
                style="width: 100%; max-width: 500px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; resize: vertical;"
            ></textarea>
            <small style="color: #666;">Si dejas vacÃ­o, se enviarÃ¡ un mensaje por defecto</small>
        </div>

        <button
            type="submit"
            style="background-color: #0078d4; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;"
        >
            ğŸ“¤ Enviar Email de Prueba
        </button>

        <div id="email-result" style="margin-top: 15px; display: none;"></div>
    </form>
</div>

<script>
document.getElementById('test-email-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const button = form.querySelector('button[type="submit"]');
    const resultDiv = document.getElementById('email-result');
    const formData = new FormData(form);

    // Deshabilitar botÃ³n y mostrar loading
    button.disabled = true;
    const originalText = button.textContent;
    button.textContent = 'â³ Enviando...';
    resultDiv.style.display = 'none';

    try {
        const response = await fetch('{% url "admin:test_email" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: new URLSearchParams({
                'email_from': formData.get('email_from'),
                'destinatario': formData.get('destinatario'),
                'mensaje': formData.get('mensaje') || ''
            })
        });

        const data = await response.json();

        // Mostrar resultado
        resultDiv.style.display = 'block';
        if (data.success) {
            resultDiv.innerHTML = `
                <div style="padding: 15px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                    <strong>âœ… Ã‰xito:</strong> ${data.message}
                    <br><small>Revisa la bandeja de entrada del destinatario</small>
                </div>
            `;
        } else {
            let errorHtml = `
                <div style="padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                    <strong>âŒ Error:</strong> ${data.error}
            `;
            if (data.hint) {
                errorHtml += `<br><br><strong>ğŸ’¡ Sugerencia:</strong> ${data.hint}`;
            }
            errorHtml += `</div>`;
            resultDiv.innerHTML = errorHtml;
        }
    } catch (error) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                <strong>âŒ Error de conexiÃ³n:</strong> ${error.message}
            </div>
        `;
    } finally {
        // Re-habilitar botÃ³n
        button.disabled = false;
        button.textContent = originalText;
    }
});
</script>

{# SecciÃ³n de Tareas AsÃ­ncronas #}
<div class="module" style="margin-top: 20px;">
    <h2>ğŸ“‹ Tareas AsÃ­ncronas Recientes</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                <th style="padding: 10px; text-align: left;">ID</th>
                <th style="padding: 10px; text-align: left;">Tipo</th>
                <th style="padding: 10px; text-align: left;">Estado</th>
                <th style="padding: 10px; text-align: left;">Programada</th>
                <th style="padding: 10px; text-align: left;">Entidades</th>
                <th style="padding: 10px; text-align: left;">DuraciÃ³n</th>
            </tr>
        </thead>
        <tbody>
            {% for tarea in tareas_recientes %}
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px;">
                    <a href="{% url 'admin:alumnos_tarea_change' tarea.id %}">#{{ tarea.id }}</a>
                </td>
                <td style="padding: 10px;">
                    {% if tarea.tipo == 'ingesta_preinscriptos' %}
                        <span style="color: #3498db; font-weight: bold;">ğŸ“¥ Preinscriptos</span>
                    {% elif tarea.tipo == 'ingesta_aspirantes' %}
                        <span style="color: #2ecc71; font-weight: bold;">ğŸ“¥ Aspirantes</span>
                    {% elif tarea.tipo == 'ingesta_ingresantes' %}
                        <span style="color: #9b59b6; font-weight: bold;">ğŸ“¥ Ingresantes</span>
                    {% elif tarea.tipo == 'eliminar_cuenta' %}
                        <span style="color: #e74c3c; font-weight: bold;">ğŸ—‘ï¸ Eliminar Cuenta</span>
                    {% elif tarea.tipo == 'enviar_email' %}
                        <span style="color: #f39c12; font-weight: bold;">ğŸ“§ Enviar Email</span>
                    {% elif tarea.tipo == 'activar_servicios' %}
                        <span style="color: #1abc9c; font-weight: bold;">ğŸš€ Activar Servicios</span>
                    {% elif tarea.tipo == 'crear_usuario_teams' %}
                        <span style="color: #34495e; font-weight: bold;">ğŸ‘¤ Crear Usuario</span>
                    {% elif tarea.tipo == 'resetear_password' %}
                        <span style="color: #e67e22; font-weight: bold;">ğŸ”‘ Resetear Password</span>
                    {% endif %}
                </td>
                <td style="padding: 10px;">
                    {% if tarea.estado == 'pending' %}
                        <span style="color: #f39c12; font-weight: bold;">â³ Pendiente</span>
                    {% elif tarea.estado == 'running' %}
                        <span style="color: #3498db; font-weight: bold;">â–¶ï¸ Ejecutando</span>
                    {% elif tarea.estado == 'completed' %}
                        <span style="color: #27ae60; font-weight: bold;">âœ… Completada</span>
                    {% elif tarea.estado == 'failed' %}
                        <span style="color: #e74c3c; font-weight: bold;">âŒ Fallida</span>
                    {% endif %}
                </td>
                <td style="padding: 10px;">{{ tarea.hora_programada|date:"d/m/Y H:i:s" }}</td>
                <td style="padding: 10px;">{{ tarea.cantidad_entidades }}</td>
                <td style="padding: 10px;">
                    {% if tarea.duracion %}
                        {{ tarea.duracion|floatformat:2 }} seg
                    {% elif tarea.estado == 'running' %}
                        <span style="color: #3498db;">En progreso...</span>
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="padding: 20px; text-align: center; color: #999;">
                    No hay tareas recientes
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <p style="margin-top: 15px;">
        <a href="{% url 'admin:alumnos_tarea_changelist' %}" style="color: #417690; font-weight: bold;">
            Ver todas las tareas â†’
        </a>
    </p>

    <div style="margin-top: 30px; padding: 15px; background-color: #e8f4f8; border-left: 4px solid #2196F3; border-radius: 4px;">
        <h3 style="margin-top: 0; color: #1976D2;">ğŸ“Š Resumen</h3>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #f39c12;">{{ resumen.pending }}</div>
                <div style="color: #666; font-size: 12px;">Pendientes</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #3498db;">{{ resumen.running }}</div>
                <div style="color: #666; font-size: 12px;">En EjecuciÃ³n</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #27ae60;">{{ resumen.completed }}</div>
                <div style="color: #666; font-size: 12px;">Completadas (24h)</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">{{ resumen.failed }}</div>
                <div style="color: #666; font-size: 12px;">Fallidas (24h)</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
