<!--
Nombre del Archivo: pylucy_index.html

DescripciÃ³n:
Template personalizado para el Ã­ndice del admin de Lucy AMS.
Incluye acciones rÃ¡pidas y widgets de informaciÃ³n del sistema.

Autor: Carlos Dagorret
Fecha de CreaciÃ³n: 2025-12-29
Ãšltima ModificaciÃ³n: 2025-12-29

Licencia: MIT
Copyright (c) 2025 Carlos Dagorret
-->
{% extends "admin/index.html" %}
{% load i18n static log %}

{% block sidebar %}
{# Ocultar el sidebar de "Acciones Recientes" de Django - usamos nuestro propio widget en el grid #}
{% endblock %}

{% block content %}
  {{ block.super }}

  {# Acciones RÃ¡pidas #}
  <div class="lucy-card" style="margin-top:16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 0; padding: 20px;">
    <h2 style="color:white; margin:0 0 16px 0; font-size: 20px;">âš¡ Acciones RÃ¡pidas</h2>

    <div class="lucy-actions">
      <a class="lucy-action" href="{% url 'admin:test_email' %}">
        <div style="font-size:36px; margin-bottom:10px;">ğŸ“§</div>
        <div style="font-weight:bold; margin-bottom:6px; font-size: 15px;">Probar Email</div>
        <div class="lucy-muted" style="font-size: 13px;">Office 365 / Graph API</div>
      </a>

      <a class="lucy-action" href="{% url 'admin:alumnos_tarea_changelist' %}">
        <div style="font-size:36px; margin-bottom:10px;">ğŸ“‹</div>
        <div style="font-weight:bold; margin-bottom:6px; font-size: 15px;">Ver Tareas</div>
        <div class="lucy-muted" style="font-size: 13px;">Tareas asÃ­ncronas</div>
      </a>

      <a class="lucy-action" href="{% url 'admin:alumnos_alumno_changelist' %}">
        <div style="font-size:36px; margin-bottom:10px;">ğŸ‘¥</div>
        <div style="font-weight:bold; margin-bottom:6px; font-size: 15px;">Alumnos</div>
        <div class="lucy-muted" style="font-size: 13px;">Gestionar alumnos</div>
      </a>

      <a class="lucy-action" href="{% url 'admin:alumnos_log_changelist' %}">
        <div style="font-size:36px; margin-bottom:10px;">ğŸ“</div>
        <div style="font-weight:bold; margin-bottom:6px; font-size: 15px;">Logs</div>
        <div class="lucy-muted" style="font-size: 13px;">Ver registros</div>
      </a>

      <a class="lucy-action" href="{% url 'admin:alumnos_configuracion_changelist' %}">
        <div style="font-size:36px; margin-bottom:10px;">âš™ï¸</div>
        <div style="font-weight:bold; margin-bottom:6px; font-size: 15px;">ConfiguraciÃ³n</div>
        <div class="lucy-muted" style="font-size: 13px;">Plantillas y ajustes</div>
      </a>
    </div>
  </div>

  {# Grid de 2 columnas: Tareas y Acciones Recientes #}
  <div class="lucy-dashboard-grid" style="margin-top:16px;">

    {# Columna 1: Tareas AsÃ­ncronas Recientes #}
    <div class="lucy-card">
      <h2>ğŸ“‹ Tareas AsÃ­ncronas Recientes</h2>

      <table>
        <thead>
          <tr style="background-color: #f5f5f5;">
            <th style="font-size:12px; padding:8px;">ID</th>
            <th style="font-size:12px; padding:8px;">Tipo</th>
            <th style="font-size:12px; padding:8px;">Estado</th>
            <th style="font-size:12px; padding:8px;">Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for tarea in tareas_recientes|slice:":8" %}
          <tr>
            <td style="padding:8px; font-size:12px;">
              <a href="{% url 'admin:alumnos_tarea_change' tarea.id %}">#{{ tarea.id }}</a>
            </td>
            <td style="padding:8px; font-size:12px;">
              {% if tarea.tipo == 'ingesta_preinscriptos' %}
                <span style="color:#3498db;">ğŸ“¥ Preinscriptos</span>
              {% elif tarea.tipo == 'ingesta_aspirantes' %}
                <span style="color:#2ecc71;">ğŸ“¥ Aspirantes</span>
              {% elif tarea.tipo == 'ingesta_ingresantes' %}
                <span style="color:#9b59b6;">ğŸ“¥ Ingresantes</span>
              {% elif tarea.tipo == 'eliminar_cuenta' %}
                <span style="color:#e74c3c;">ğŸ—‘ï¸ Eliminar</span>
              {% elif tarea.tipo == 'enviar_email' %}
                <span style="color:#f39c12;">ğŸ“§ Email</span>
              {% elif tarea.tipo == 'activar_servicios' %}
                <span style="color:#1abc9c;">ğŸš€ Activar</span>
              {% elif tarea.tipo == 'crear_usuario_teams' %}
                <span style="color:#34495e;">ğŸ‘¤ Usuario</span>
              {% elif tarea.tipo == 'resetear_password' %}
                <span style="color:#e67e22;">ğŸ”‘ Password</span>
              {% endif %}
            </td>
            <td style="padding:8px; font-size:12px;">
              {% if tarea.estado == 'pending' %}
                <span style="color:#f39c12;">â³</span>
              {% elif tarea.estado == 'running' %}
                <span style="color:#3498db;">â–¶ï¸</span>
              {% elif tarea.estado == 'completed' %}
                <span style="color:#27ae60;">âœ…</span>
              {% elif tarea.estado == 'failed' %}
                <span style="color:#e74c3c;">âŒ</span>
              {% endif %}
            </td>
            <td style="padding:8px; font-size:11px; color:#666;">
              {{ tarea.hora_programada|date:"d/m H:i" }}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" style="padding:20px; text-align:center; color:#999; font-size:12px;">
              No hay tareas recientes
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <p style="margin-top:15px; text-align:right;">
        <a href="{% url 'admin:alumnos_tarea_changelist' %}" style="color:#417690; font-weight:bold; font-size:12px;">
          Ver todas las tareas â†’
        </a>
      </p>

      {# Resumen compacto #}
      <div style="margin-top:20px; padding:15px; background-color:#f9f9f9; border-radius:4px;">
        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; text-align:center;">
          <div>
            <div style="font-size:20px; font-weight:bold; color:#f39c12;">{{ resumen.pending }}</div>
            <div class="lucy-muted">Pendientes</div>
          </div>
          <div>
            <div style="font-size:20px; font-weight:bold; color:#3498db;">{{ resumen.running }}</div>
            <div class="lucy-muted">Ejecutando</div>
          </div>
          <div>
            <div style="font-size:20px; font-weight:bold; color:#27ae60;">{{ resumen.completed }}</div>
            <div class="lucy-muted">Completadas</div>
          </div>
          <div>
            <div style="font-size:20px; font-weight:bold; color:#e74c3c;">{{ resumen.failed }}</div>
            <div class="lucy-muted">Fallidas</div>
          </div>
        </div>
      </div>
    </div>

    {# Columna 2: Acciones Recientes (widget de Django) #}
    <div class="lucy-card">
      <h2>ğŸ•’ Acciones Recientes</h2>

      {% get_admin_log 10 as admin_log for_user user %}
      <ul style="list-style:none; padding:0; margin:0;">
        {% for entry in admin_log %}
        <li style="padding:10px; border-bottom:1px solid rgba(0,0,0,0.06); font-size:12px;">
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div style="flex:1;">
              {% if entry.is_addition %}
                <span style="color:#27ae60; font-weight:bold;">â•</span>
              {% elif entry.is_change %}
                <span style="color:#3498db; font-weight:bold;">âœï¸</span>
              {% elif entry.is_deletion %}
                <span style="color:#e74c3c; font-weight:bold;">ğŸ—‘ï¸</span>
              {% endif %}

              {% if entry.content_type %}
                <strong>{{ entry.content_type.name|capfirst }}</strong>
              {% endif %}

              {% if entry.is_deletion %}
                {{ entry.object_repr }}
              {% else %}
                <a href="{{ entry.get_admin_url }}">{{ entry.object_repr }}</a>
              {% endif %}

              {% if entry.change_message %}
                <div class="lucy-muted" style="margin-top:3px;">
                  {{ entry.change_message }}
                </div>
              {% endif %}
            </div>
            <div class="lucy-muted" style="white-space:nowrap; margin-left:10px;">
              {{ entry.action_time|date:"d/m H:i" }}
            </div>
          </div>
        </li>
        {% empty %}
        <li style="padding:20px; text-align:center; color:#999; font-size:12px;">
          No hay acciones recientes
        </li>
        {% endfor %}
      </ul>
    </div>

  </div>

{% endblock %}
