# 01.01-Cursos - Plan de implementación paso a paso

Guía breve para aterrizar el módulo de Cursos (ingreso → Moodle) en Django.

## 1) Modelado y migrations
- Crear app específica `cursos` (si no existe).
- Modelos base:
  - `CursoIngreso` (normales): `nombre`, `curso_moodle`, `carreras` (ArrayField o JSONField de códigos), `activo`.
  - `CursoRaro` (excepciones): `nombre`, `comision`, `curso_moodle`, `carreras` (Array/JSON), `activo`.
- Si se usa PostgreSQL: ArrayField para `carreras`. Si no, JSONField + validación.
- Migraciones iniciales.

## 2) Administración (Django Admin)
- Registrar `CursoIngreso` y `CursoRaro` con:
  - `list_display`, `search_fields`, `list_filter` (incluyendo `activo` y `carreras` si aplica).
  - Formularios que normalicen `carreras` (split por coma → lista).
  - `has_*_permission` respetando permisos/roles definidos.

## 3) Permisos y roles (ya definidos en accounts)
- Usar permisos custom de `accounts` para menú/acciones (configuración cursos/mapero).
- Proteger menús/vistas con `has_perm("accounts.config_cursos")` y/o `config_mapero`.

## 4) Lógica de mapeo (servicio)
- Servicio puro Python `resolver_curso(codigo_carrera, comision)`:
  1. Buscar en `CursoRaro` por `(carrera ∈ carreras) AND comision`.
  2. Si no, buscar en `CursoIngreso` por `carrera ∈ carreras`.
  3. Si no hay coincidencia → retornar error de mapeo.
- Función para procesar lote: recibe lista de alumnos (`id_carrera`, `comision`, etc.), convierte `id_carrera` → `codigo_carrera` usando diccionario `CARRERAS`, y aplica `resolver_curso`.
- Devolver listas: `enrolamientos_ok` y `errores`.

## 5) Diccionario de carreras
- Fuente: JSON `carreras.json` o constante. Cargar en settings o en módulo `cursos/constants.py`.
- Validar que todos los `id_carrera` entrantes existan.

## 6) Vistas/API
- Vista de prueba (HTML o API) para subir lote JSON/CSV y mostrar resultado de mapeo (OK/errores).
- Si se usa DRF: endpoint protegido por permisos `accounts.config_cursos` y/o `accounts.config_mapero`.

## 7) Tareas/Batch
- Comando de management `mapear_cursos` que:
  - Lee archivo JSON/CSV de alumnos.
  - Corre mapeo y genera CSV de enrolamiento (username, course_shortname, role).
  - Reporta errores en archivo aparte.

## 8) Tests
- Unitarios de `resolver_curso` cubriendo:
  - Caso raro exacto.
  - Caso normal.
  - Sin coincidencia → error.
  - Carreras múltiples en una definición.
- Tests de admin/form normalizando `carreras`.

## 9) UX rápida en admin
- Filtros por `activo`, `carreras` (si es ArrayField, usar `__contains` o filtros custom).
- Help-text explicando formato de `carreras` (ej: `CP,LE,LA`).

## 10) Despliegue
- `collectstatic`, migraciones y verificación de permisos/roles (`seed_initial_data` si se usa).
- Asegurar `LANGUAGE_CODE` y `TIME_ZONE` ya en es-AR (listo en settings).
