# TODO: Integraci√≥n de Servicios (Moodle/Teams/Email)

**Fecha**: 2025-12-10
**Tag**: `#ETME` (Environment Testing Mode)
**Objetivo**: Implementar y probar la integraci√≥n completa con servicios externos

---

## üìã Tareas Pendientes

### üîê Fase 1: Credenciales de Servicios

#### ‚úÖ TODO 1: Obtener token de Moodle Sandbox
**Estado**: Pendiente

**Pasos**:
1. Acceder a https://sandbox.moodledemo.net
2. Iniciar sesi√≥n con credenciales p√∫blicas
3. Navegar a: Administraci√≥n del sitio ‚Üí Servidor ‚Üí Servicios web
4. Crear token para webservices
5. Habilitar funciones necesarias:
   - `core_user_create_users`
   - `enrol_manual_enrol_users`
   - `core_course_get_courses`
6. Copiar token generado
7. Actualizar en `docker-compose.dev.yml`:
   ```yaml
   - MOODLE_WSTOKEN=TOKEN_AQUI
   ```

**Notas**:
- El sandbox se resetea cada hora
- Guardar token en lugar seguro para reconfigurar si es necesario

---

#### ‚úÖ TODO 2: Configurar App Registration de Teams
**Estado**: Pendiente

**Pasos**:
1. Acceder a Azure Portal (portal.azure.com)
2. Ir a: Azure Active Directory ‚Üí App registrations ‚Üí New registration
3. Configurar:
   - Name: `PyLucy-Testing`
   - Supported account types: Single tenant (eco.unrc.edu.ar)
   - Redirect URI: (opcional por ahora)
4. Copiar:
   - Application (client) ID
   - Directory (tenant) ID
5. Ir a: Certificates & secrets ‚Üí New client secret
6. Copiar el valor del secret (solo se muestra una vez)
7. Ir a: API permissions ‚Üí Add permission ‚Üí Microsoft Graph
8. Agregar permisos delegados:
   - `User.ReadWrite.All`
   - `Directory.ReadWrite.All`
   - `Group.ReadWrite.All`
9. Click en "Grant admin consent"
10. Actualizar en `docker-compose.dev.yml`:
    ```yaml
    - TEAMS_CLIENT_ID=CLIENT_ID_AQUI
    - TEAMS_CLIENT_SECRET=CLIENT_SECRET_AQUI
    ```

**Notas**:
- Requiere permisos de administrador del tenant
- Usar App Registration separada para testing y producci√≥n

---

### üîß Fase 2: Servicios de Integraci√≥n

#### ‚úÖ TODO 3: Implementar email_service.py
**Estado**: Pendiente

**Ubicaci√≥n**: `src/alumnos/services/email_service.py`

**Funcionalidades**:
- `send_welcome_email(alumno)` - Email de bienvenida a aspirantes
- `send_credentials_email(alumno)` - Env√≠o de credenciales Teams/Moodle
- `send_enrollment_confirmation(alumno, curso)` - Confirmaci√≥n de enrolamiento
- `send_status_change_email(alumno, old_status, new_status)` - Cambio de estado

**Estructura b√°sica**:
```python
from django.core.mail import send_mail
from django.conf import settings
from typing import Optional
import logging

logger = logging.getLogger(__name__)

class EmailService:
    """Cliente SMTP para env√≠o de emails"""

    def send_welcome_email(self, alumno) -> bool:
        """Env√≠a email de bienvenida"""
        pass

    def send_credentials_email(self, alumno) -> bool:
        """Env√≠a credenciales de acceso"""
        pass

    def send_enrollment_confirmation(self, alumno, curso: str) -> bool:
        """Confirma enrolamiento en curso"""
        pass
```

**Tests**:
- Verificar env√≠o v√≠a MailHog (localhost:8025)
- Validar formato HTML de emails
- Probar con/sin credenciales

---

#### ‚úÖ TODO 4: Implementar teams_service.py
**Estado**: Pendiente

**Ubicaci√≥n**: `src/alumnos/services/teams_service.py`

**Funcionalidades**:
- `create_user(alumno)` - Crear usuario en Teams/Azure AD
- `get_user(upn)` - Buscar usuario existente
- `update_user(upn, data)` - Actualizar datos de usuario
- `reset_password(upn)` - Resetear contrase√±a
- `delete_test_users()` - Limpieza de usuarios test-*

**Estructura b√°sica**:
```python
import requests
from django.conf import settings
from typing import Optional, Dict
import logging

logger = logging.getLogger(__name__)

class TeamsService:
    """Cliente Graph API para gesti√≥n de usuarios en Teams"""

    BASE_URL = "https://graph.microsoft.com/v1.0"

    def __init__(self):
        self.tenant = settings.TEAMS_TENANT
        self.client_id = settings.TEAMS_CLIENT_ID
        self.client_secret = settings.TEAMS_CLIENT_SECRET
        self._token = None

    def _get_token(self) -> str:
        """Obtiene token OAuth2 de Microsoft"""
        pass

    def create_user(self, alumno) -> Optional[Dict]:
        """Crea usuario en Azure AD"""
        pass

    def get_user(self, upn: str) -> Optional[Dict]:
        """Busca usuario por UPN"""
        pass
```

**Tests**:
- Crear usuario con prefijo test-
- Verificar en Azure AD
- Probar obtenci√≥n de token OAuth2

---

#### ‚úÖ TODO 5: Implementar moodle_service.py
**Estado**: Pendiente

**Ubicaci√≥n**: `src/alumnos/services/moodle_service.py`

**Funcionalidades**:
- `create_user(alumno)` - Crear usuario en Moodle
- `enroll_user(username, course_id)` - Enrolar en curso
- `get_courses()` - Listar cursos disponibles
- `get_user_enrollments(username)` - Ver enrolamientos de usuario

**Estructura b√°sica**:
```python
import requests
from django.conf import settings
from typing import Optional, List, Dict
import logging

logger = logging.getLogger(__name__)

class MoodleService:
    """Cliente Moodle API para gesti√≥n de usuarios y enrolamientos"""

    def __init__(self):
        self.base_url = settings.MOODLE_BASE_URL
        self.token = settings.MOODLE_WSTOKEN
        self.ws_endpoint = f"{self.base_url}/webservice/rest/server.php"

    def _call_api(self, wsfunction: str, **params) -> Dict:
        """Llamada gen√©rica a Moodle Web Services"""
        pass

    def create_user(self, alumno) -> Optional[Dict]:
        """Crea usuario en Moodle"""
        pass

    def enroll_user(self, username: str, course_id: int) -> bool:
        """Enrola usuario en curso"""
        pass

    def get_courses(self) -> List[Dict]:
        """Lista cursos disponibles"""
        pass
```

**Tests**:
- Crear usuario en Sandbox
- Enrolar en curso de prueba
- Verificar v√≠a interfaz web de Moodle

---

### üéØ Fase 3: Integraci√≥n Django

#### ‚úÖ TODO 6: Crear acciones admin para activar servicios
**Estado**: Pendiente

**Ubicaci√≥n**: `src/alumnos/admin.py`

**Acciones a agregar**:
1. **"Activar servicios (Teams + Moodle + Email)"** - Acci√≥n completa
2. **"Crear usuario Teams"** - Solo Teams
3. **"Enrolar en Moodle"** - Solo Moodle
4. **"Enviar email credenciales"** - Solo Email
5. **"Resetear contrase√±a Teams"** - Utilidad

**Estructura b√°sica**:
```python
from django.contrib import admin
from .services.email_service import EmailService
from .services.teams_service import TeamsService
from .services.moodle_service import MoodleService

@admin.action(description="üöÄ Activar servicios (Teams + Moodle + Email)")
def activar_servicios_completo(modeladmin, request, queryset):
    """Activa Teams, Moodle y env√≠a email para aspirantes"""
    email_svc = EmailService()
    teams_svc = TeamsService()
    moodle_svc = MoodleService()

    for alumno in queryset:
        # Solo para aspirantes o superior
        if alumno.estado_actual not in ['aspirante', 'ingresante', 'alumno']:
            continue

        # 1. Crear usuario Teams
        teams_svc.create_user(alumno)

        # 2. Crear y enrolar en Moodle
        moodle_svc.create_user(alumno)
        # TODO: Resolver curso seg√∫n carrera/modalidad/comisi√≥n

        # 3. Enviar email con credenciales
        email_svc.send_credentials_email(alumno)
```

**Tests**:
- Seleccionar alumnos en admin
- Ejecutar acci√≥n
- Verificar en cada servicio

---

#### ‚úÖ TODO 7: Integrar servicios en flujo de ingesta
**Estado**: Pendiente

**Ubicaci√≥n**: `src/alumnos/services.py`

**Modificaciones**:
- En `consumir_y_actualizar()`: Detectar cambio de estado a "aspirante"
- Triggear activaci√≥n autom√°tica de servicios
- Registrar logs de ejecuci√≥n

**Pseudoc√≥digo**:
```python
def consumir_y_actualizar(tipo_estado: str):
    # ... c√≥digo existente ...

    for item in lista:
        alumno, created = Alumno.objects.update_or_create(...)

        # Si cambi√≥ a aspirante, activar servicios
        if not created and alumno.estado_actual == 'aspirante':
            activar_servicios_para_aspirante(alumno)
```

**Consideraciones**:
- Hacer activaci√≥n as√≠ncrona (Celery/Django-Q) para no bloquear
- Manejar errores de servicios externos gracefully
- Registrar intentos/reintentos

---

### üß™ Fase 4: Testing Completo

#### ‚úÖ TODO 8: Probar env√≠o de email v√≠a MailHog
**Estado**: Pendiente

**Pasos**:
1. Levantar entorno dev: `./dev.sh`
2. Verificar MailHog en http://localhost:8025
3. Crear alumno aspirante desde admin
4. Ejecutar acci√≥n "Enviar email credenciales"
5. Verificar recepci√≥n en MailHog
6. Validar:
   - ‚úÖ Email con formato correcto
   - ‚úÖ Credenciales incluidas
   - ‚úÖ Links funcionales

**Resultado esperado**:
- Email visible en interfaz MailHog
- Formato HTML correcto
- Datos del alumno presentes

---

#### ‚úÖ TODO 9: Probar creaci√≥n de usuario en Teams
**Estado**: Pendiente

**Pasos**:
1. Configurar credenciales Teams (TODO 2)
2. Crear alumno con DNI 12345678
3. Ejecutar acci√≥n "Crear usuario Teams"
4. Verificar en Azure AD:
   - Usuario: `test-a12345678@eco.unrc.edu.ar`
   - Display Name correcto
   - Contrase√±a temporal asignada
5. Intentar login en Teams con credenciales

**Resultado esperado**:
- Usuario creado en tenant
- Prefijo `test-` presente
- Login funcional

---

#### ‚úÖ TODO 10: Probar enrolamiento en Moodle Sandbox
**Estado**: Pendiente

**Pasos**:
1. Configurar token Moodle (TODO 1)
2. Listar cursos disponibles: `moodle_svc.get_courses()`
3. Crear usuario en Moodle
4. Enrolar en curso de prueba
5. Verificar en interfaz web Moodle Sandbox
6. Validar:
   - ‚úÖ Usuario visible en participantes
   - ‚úÖ Enrolamiento activo
   - ‚úÖ Email correcto

**Resultado esperado**:
- Usuario enrolado en curso
- Visible en Moodle Sandbox
- Puede acceder al curso

**Nota**: Recordar que Sandbox resetea cada hora

---

#### ‚úÖ TODO 11: Probar flujo completo de evoluci√≥n
**Estado**: Pendiente

**Pasos**:
1. Levantar mock-api-uti
2. Consumir endpoint `/preinscriptos`
3. Verificar creaci√≥n con `estado_actual=preinscripto`
4. Consumir endpoint `/aspirantes` (mismo DNI)
5. Verificar evoluci√≥n a `estado_actual=aspirante`
6. Validar activaci√≥n autom√°tica de servicios:
   - ‚úÖ Usuario creado en Teams
   - ‚úÖ Usuario enrolado en Moodle
   - ‚úÖ Email enviado v√≠a MailHog
7. Consumir endpoint `/ingresantes` (mismo DNI)
8. Verificar evoluci√≥n a `estado_actual=ingresante`
9. Validar que NO retrocede estados

**Resultado esperado**:
- Evoluci√≥n correcta: preinscripto ‚Üí aspirante ‚Üí ingresante
- Servicios activados solo en transici√≥n a aspirante
- No duplicaci√≥n de usuarios
- Logs completos de proceso

---

#### ‚úÖ TODO 12: Crear script de limpieza de cuentas test-*
**Estado**: Pendiente

**Ubicaci√≥n**: `src/alumnos/management/commands/cleanup_test_accounts.py`

**Funcionalidades**:
- Listar todas las cuentas con prefijo `test-a`
- Eliminar de Teams/Azure AD
- Opci√≥n dry-run para preview
- Logs detallados

**Estructura b√°sica**:
```python
from django.core.management.base import BaseCommand
from alumnos.services.teams_service import TeamsService

class Command(BaseCommand):
    help = 'Limpia cuentas de testing (test-*) en Teams/Azure AD'

    def add_arguments(self, parser):
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Solo listar, no eliminar',
        )

    def handle(self, *args, **options):
        teams_svc = TeamsService()
        dry_run = options['dry_run']

        # Listar usuarios test-*
        test_users = teams_svc.list_test_users()

        self.stdout.write(f"Encontrados {len(test_users)} usuarios test-")

        if dry_run:
            # Solo mostrar
            for user in test_users:
                self.stdout.write(f"  - {user['upn']}")
        else:
            # Eliminar
            for user in test_users:
                teams_svc.delete_user(user['upn'])
                self.stdout.write(f"‚úì Eliminado: {user['upn']}")
```

**Uso**:
```bash
# Preview
python manage.py cleanup_test_accounts --dry-run

# Ejecutar limpieza
python manage.py cleanup_test_accounts
```

---

## üìä Resumen de Progreso

| Fase | Tareas | Completadas | Pendientes |
|------|--------|-------------|------------|
| 1. Credenciales | 2 | 0 | 2 |
| 2. Servicios | 3 | 0 | 3 |
| 3. Integraci√≥n | 2 | 0 | 2 |
| 4. Testing | 5 | 0 | 5 |
| **TOTAL** | **12** | **0** | **12** |

---

## üîó Archivos Relacionados

- `src/alumnos/services.py` - L√≥gica de ingesta y payloads
- `src/pylucy/settings.py` - Variables de entorno (#ETME)
- `docker-compose.dev.yml` - Configuraci√≥n desarrollo
- `doc/TESTING-VS-PRODUCCION.md` - Estrategia testing
- `doc/VARIABLES-ENTORNO.md` - Referencia de variables
- `doc/estrategia-testing-integracion.md` - Estrategia de integraci√≥n

---

## ‚ö†Ô∏è Notas Importantes

1. **Orden de implementaci√≥n**: Seguir el orden sugerido (credenciales ‚Üí servicios ‚Üí integraci√≥n ‚Üí testing)
2. **Prefijo test- obligatorio**: NUNCA crear cuentas sin prefijo en testing
3. **Moodle Sandbox resetea cada hora**: No usar para datos persistentes
4. **Rate limiting**: Graph API tiene l√≠mites, implementar throttling
5. **Manejo de errores**: Todos los servicios deben fallar gracefully
6. **Logs**: Implementar logging detallado en todos los servicios
7. **Tests unitarios**: Agregar tests para cada servicio

---

## üöÄ Comandos √ötiles

```bash
# Levantar entorno desarrollo
./dev.sh

# Verificar modo actual
docker exec pylucy-web-dev python manage.py check_environment

# Ver MailHog
open http://localhost:8025

# Ver logs
docker compose -f docker-compose.dev.yml logs -f web

# Ejecutar tests
docker exec pylucy-web-dev python manage.py test alumnos.tests
```

---

**√öltima actualizaci√≥n**: 2025-12-10
**Autor**: Sistema Lucy AMS
**Estado**: 0/12 tareas completadas
