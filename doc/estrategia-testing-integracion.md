# Estrategia de Testing para Integraci√≥n de Servicios

## üéØ Objetivo

Probar la integraci√≥n completa del flujo de alumnos (Preinscriptos ‚Üí Aspirantes ‚Üí Ingresantes) con servicios reales:
- Env√≠o de emails
- Creaci√≥n de cuentas en Microsoft Teams
- Enrolamiento en Moodle

---

## üîß Servicios a Utilizar

### 1Ô∏è‚É£ **Email: MailHog** ‚úÖ
**Estado**: Ya configurado

- **Servicio**: MailHog (SMTP Testing)
- **URL Web**: http://localhost:8025
- **SMTP**: localhost:1025
- **Configuraci√≥n**: `docker-compose.dev.yml`

**Ventajas**:
- Captura todos los emails sin enviarlos realmente
- Interfaz web para visualizar
- No requiere credenciales reales

---

### 2Ô∏è‚É£ **Moodle: Sandbox Demo**

**Servicio**: Moodle Sandbox Oficial
- **URL**: https://sandbox.moodledemo.net/
- **Versi√≥n**: Moodle 5.1 (√∫ltima estable)
- **Reset**: Cada hora en punto (00:00, 01:00, 02:00...)
- **Credenciales**: Disponibles en el sitio p√∫blico

**‚ö†Ô∏è Limitaciones**:
- Se resetea cada hora (usuarios/cursos creados se pierden)
- Ideal para testing puntual, no para desarrollo continuo

**API Endpoints** (a configurar):
```
Base URL: https://sandbox.moodledemo.net
Webservice: /webservice/rest/server.php
Token: [Obtener desde Moodle Sandbox tras login]
```

**Funciones a probar**:
- `core_user_create_users` - Crear usuarios
- `enrol_manual_enrol_users` - Enrolar en cursos
- `core_course_get_courses` - Listar cursos disponibles

---

### 3Ô∏è‚É£ **Microsoft Teams: Tenant Actual (eco.unrc.edu.ar)**

**Servicio**: Tenant institucional existente
- **Dominio**: eco.unrc.edu.ar
- **Tenant ID**: [A configurar]
- **Graph API**: https://graph.microsoft.com/v1.0

**üîê Convenci√≥n de Cuentas de Testing**

Todas las cuentas creadas para testing usar√°n el prefijo `test-`:

```
Formato: test-a[DNI]@eco.unrc.edu.ar

Ejemplos:
  - test-a12345678@eco.unrc.edu.ar
  - test-a87654321@eco.unrc.edu.ar
```

**Ventajas del prefijo `test-`**:
- ‚úÖ Identificaci√≥n inmediata de cuentas de prueba
- ‚úÖ F√°cil filtrado para limpieza masiva
- ‚úÖ No contamina el directorio con usuarios reales
- ‚úÖ Permite scripts de borrado selectivo

**Script de limpieza** (PowerShell + Graph API):
```powershell
# Listar todas las cuentas test-
Get-MgUser -Filter "startswith(userPrincipalName,'test-a')"

# Eliminar todas las cuentas test-
Get-MgUser -Filter "startswith(userPrincipalName,'test-a')" |
  ForEach-Object { Remove-MgUser -UserId $_.Id }
```

**Permisos requeridos en App Registration**:
- `User.ReadWrite.All` - Crear/modificar usuarios
- `Group.ReadWrite.All` - Asignar a grupos (opcional)
- `Directory.ReadWrite.All` - Gesti√≥n de directorio

---

## üìä Flujo de Testing

### Fase 1: Preinscripto
1. Consumir desde mock-api-uti
2. Crear registro en BD con `estado_actual="preinscripto"`
3. **NO se crean cuentas** (solo preparaci√≥n)

### Fase 2: Aspirante (Activaci√≥n de Servicios)
1. Consumir desde mock-api-uti (evoluciona de preinscripto ‚Üí aspirante)
2. **Crear cuenta Teams**: `test-a[DNI]@eco.unrc.edu.ar`
3. **Enviar email bienvenida** via MailHog
4. **Enrolar en curso de ingreso Moodle** (seg√∫n carrera/modalidad/comisi√≥n)

### Fase 3: Ingresante
1. Consumir desde mock-api-uti (evoluciona de aspirante ‚Üí ingresante)
2. **Actualizar grupos Teams** (opcional)
3. **Cambiar rol en Moodle** (student ‚Üí advanced)

### Fase 4: Alumno
1. Promoci√≥n manual o autom√°tica
2. **Enrolar en materias del plan de estudio** (futuro)

---

## üîê Configuraci√≥n de Variables de Entorno

Actualizar `docker-compose.dev.yml`:

```yaml
environment:
  # SIAL/UTI (ya configurado)
  - SIAL_BASE_URL=http://host.docker.internal:8088

  # Email (ya configurado)
  - EMAIL_HOST=mailhog
  - EMAIL_PORT=1025

  # Microsoft Teams / Graph API
  - TEAMS_TENANT_ID=eco.unrc.edu.ar
  - TEAMS_CLIENT_ID=[App Registration Client ID]
  - TEAMS_CLIENT_SECRET=[App Registration Secret]
  - TEAMS_DOMAIN=eco.unrc.edu.ar
  - TEAMS_TEST_PREFIX=test-a

  # Moodle Sandbox
  - MOODLE_BASE_URL=https://sandbox.moodledemo.net
  - MOODLE_WSTOKEN=[Token obtenido del sandbox]
  - MOODLE_WSFUNCTION=webservice/rest/server.php
```

---

## üìù Payloads Generados

Cada alumno tiene 3 payloads en formato JSON:

### `teams_payload`
```json
{
  "auth": {
    "tenant": "eco.unrc.edu.ar",
    "client_id": "CLIENT_ID",
    "client_secret": "CLIENT_SECRET"
  },
  "usuario": {
    "upn": "test-a12345678@eco.unrc.edu.ar",
    "display_name": "Apellido, Nombre",
    "password": "AutoGeneratedPassword123"
  },
  "acciones": ["buscar_usuario", "crear_si_no_existe", "asignar_licencia"],
  "api": {
    "buscar_usuario": "https://graph.microsoft.com/v1.0/users/{upn}",
    "crear_usuario": "https://graph.microsoft.com/v1.0/users",
    "asignar_licencia": "https://graph.microsoft.com/v1.0/users/{id}/assignLicense"
  }
}
```

### `email_payload`
```json
{
  "metadata": {
    "origen": "sial-mock",
    "tipo": "aspirante"
  },
  "email": {
    "from": "no-reply@eco.unrc.edu.ar",
    "to": "test-a12345678@eco.unrc.edu.ar",
    "subject": "Bienvenido al sistema - UNRC",
    "body": "..."
  },
  "api": {
    "enviar": "mailhog:1025"
  }
}
```

### `moodle_payload`
```json
{
  "auth": {
    "domain": "https://sandbox.moodledemo.net",
    "token": "MOODLE_TOKEN"
  },
  "usuario": {
    "username": "test-a12345678@eco.unrc.edu.ar",
    "email": "test-a12345678@eco.unrc.edu.ar",
    "login_via": "microsoft_teams"
  },
  "acciones": {
    "enrolar": {
      "courses": ["CURSO_INGRESO_CP_PRES_01"]
    },
    "enviar_correo_enrolamiento": true
  },
  "api": {
    "crear_usuario": "https://sandbox.moodledemo.net/webservice/rest/server.php?wsfunction=core_user_create_users",
    "enrolar_usuario": "https://sandbox.moodledemo.net/webservice/rest/server.php?wsfunction=enrol_manual_enrol_users"
  }
}
```

---

## ‚úÖ Checklist de Implementaci√≥n

### Preparaci√≥n
- [x] Mock-api-uti funcionando
- [x] MailHog configurado
- [ ] Obtener credenciales App Registration (Teams)
- [ ] Obtener token de Moodle Sandbox
- [ ] Actualizar variables de entorno

### Desarrollo
- [ ] Crear servicio `teams_service.py` (Graph API client)
- [ ] Crear servicio `moodle_service.py` (Moodle API client)
- [ ] Crear servicio `email_service.py` (SMTP client)
- [ ] Actualizar `services.py` para usar prefijo `test-`
- [ ] Agregar acciones admin "Activar Servicios"

### Testing
- [ ] Probar env√≠o de email v√≠a MailHog
- [ ] Probar creaci√≥n de usuario Teams
- [ ] Probar enrolamiento Moodle Sandbox
- [ ] Probar flujo completo Preinscripto ‚Üí Aspirante

### Limpieza
- [ ] Script para borrar cuentas `test-*` de Teams
- [ ] Documentar proceso de reset

---

## üö® Notas Importantes

1. **Moodle Sandbox se resetea cada hora**: No uses para datos persistentes
2. **Prefijo test- es OBLIGATORIO**: Nunca crear cuentas sin este prefijo en producci√≥n
3. **Credenciales Teams**: Requiere App Registration con permisos admin consent
4. **Rate Limiting**: Graph API tiene l√≠mites, usar throttling en producci√≥n

---

## üìö Referencias

- [Microsoft Graph API - Users](https://learn.microsoft.com/en-us/graph/api/user-post-users)
- [Moodle Web Services](https://docs.moodle.org/dev/Web_services)
- [Moodle Sandbox](https://sandbox.moodledemo.net/)
- [MailHog Documentation](https://github.com/mailhog/MailHog)

---

**√öltima actualizaci√≥n**: 2025-12-08
**Autor**: Sistema Lucy AMS
