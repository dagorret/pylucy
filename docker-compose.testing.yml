version: "3.9"

# Docker Compose para servidor de testing (Alfa 1)
# Usa configuraci√≥n de desarrollo para simplicidad
# Expone puertos para acceso directo

services:
  db:
    image: postgres:16
    container_name: pylucy-db-testing
    restart: always
    environment:
      - POSTGRES_DB=pylucy
      - POSTGRES_USER=pylucy
      - POSTGRES_PASSWORD=pylucy
    ports:
      - "5432:5432"
    volumes:
      - pylucy-db-testing:/var/lib/postgresql/data
    networks:
      - pylucy-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pylucy"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: pylucy-redis-testing
    restart: always
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - pylucy-redis-testing:/data
    networks:
      - pylucy-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  web:
    build: .
    container_name: pylucy-web-testing
    working_dir: /app
    command: python manage.py runserver 0.0.0.0:8000
    env_file:
      - .env.dev
    ports:
      - "8000:8000"
    volumes:
      - ./src:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - pylucy-net
    restart: always

  celery:
    build: .
    container_name: pylucy-celery-testing
    working_dir: /app
    command: celery -A pylucy worker -l info
    env_file:
      - .env.dev
    volumes:
      - ./src:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - pylucy-net
    restart: always

  celery-beat:
    build: .
    container_name: pylucy-celery-beat-testing
    working_dir: /app
    command: celery -A pylucy beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    env_file:
      - .env.dev
    volumes:
      - ./src:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - pylucy-net
    restart: always

  mailhog:
    image: mailhog/mailhog
    container_name: pylucy-mailhog-testing
    restart: always
    ports:
      - "8025:8025"   # UI Web
      - "1025:1025"   # SMTP
    networks:
      - pylucy-net

  pgadmin:
    image: dpage/pgadmin4
    container_name: pylucy-pgadmin-testing
    restart: always
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@unrc.edu.ar
      - PGADMIN_DEFAULT_PASSWORD=admin
    ports:
      - "5050:80"
    networks:
      - pylucy-net

networks:
  pylucy-net:
    driver: bridge

volumes:
  pylucy-db-testing:
  pylucy-redis-testing:
